<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>AtomoTech ‚Äî Sistema</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#f4f6f8; }
    header { background:#0b66ff; color:white; padding:16px; text-align:center; font-size:20px; font-weight:bold; }
    main { padding:20px; text-align:center; }

    .btn {
      display:inline-block; margin:8px; padding:12px 20px;
      border:none; border-radius:8px; cursor:pointer; font-size:15px; font-weight:bold;
      color:white; transition:0.3s;
    }
    .btn:hover { opacity:0.85; }

    /* Cores */
    .btn-green { background:#28a745; }
    .btn-blue { background:#007bff; }
    .btn-gold { background:#d4a017; }
    .btn-grey { background:#6c757d; }
    .btn-red { background:#dc3545; }

    .section {
      display:none; text-align:left; margin-top:20px;
      background:white; padding:20px; border-radius:10px;
      box-shadow:0 0 8px rgba(0,0,0,0.1);
    }
    label { display:block; margin-top:10px; }
    input, textarea, select { width:100%; padding:8px; margin-top:4px; }
    table { width:100%; border-collapse:collapse; margin-top:15px; }
    table, th, td { border:1px solid #ccc; }
    th, td { padding:8px; text-align:left; }

    .registro {
      padding:10px; margin:6px 0;
      border:1px solid #ccc; border-radius:6px;
      display:flex; justify-content:space-between; align-items:center;
      background:#fdfdfd;
    }
  </style>
</head>
<body>
  <header>AtomoTech ‚Äî Sistema de Or√ßamentos & OS</header>
  <main>
    <button class="btn btn-green" onclick="abrirSecao('orcamento')">Criar Or√ßamento</button>
    <button class="btn btn-blue" onclick="abrirSecao('os')">Criar Ordem de Servi√ßo</button>
    <button class="btn btn-gold" onclick="abrirSecao('consulta')">Gerenciar Documentos</button>

    <!-- Or√ßamento -->
    <section id="orcamento" class="section">
      <h2>Or√ßamento</h2>
      <label>Cliente: <input type="text" id="orcCliente"></label>
      <label>Descri√ß√£o: <textarea id="orcDescricao"></textarea></label>
      <h3>Itens</h3>
      <table id="tabelaOrcamento">
        <thead>
          <tr><th>Descri√ß√£o</th><th>Qtd</th><th>Valor Unit.</th><th>Total</th><th>A√ß√£o</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <button class="btn btn-grey" onclick="adicionarItem('orcamento')">Adicionar Item</button>
      <br>
      <button class="btn btn-green" onclick="salvarRegistro('orcamento')">Salvar</button>
      <button class="btn btn-grey" onclick="limparFormulario('orcamento')">Limpar</button>
      <button class="btn btn-red" onclick="gerarPDFFromForm('orcamento')">Gerar PDF</button>
      <button class="btn btn-blue" onclick="abrirSecao('')">Voltar</button>
    </section>

    <!-- OS -->
    <section id="os" class="section">
      <h2>Ordem de Servi√ßo</h2>
      <label>Cliente: <input type="text" id="osCliente"></label>
      <label>Servi√ßo: <textarea id="osServico"></textarea></label>
      <label>T√©cnico Respons√°vel: <input type="text" id="osTecnico"></label>
      <h3>Equipamentos Usados</h3>
      <table id="tabelaEquipamentos">
        <thead>
          <tr><th>Descri√ß√£o</th><th>Qtd</th><th>Valor Unit.</th><th>Total</th><th>A√ß√£o</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <button class="btn btn-grey" onclick="adicionarItem('equipamento')">Adicionar Equipamento</button>
      <br>
      <button class="btn btn-green" onclick="salvarRegistro('os')">Salvar</button>
      <button class="btn btn-grey" onclick="limparFormulario('os')">Limpar</button>
      <button class="btn btn-red" onclick="gerarPDFFromForm('os')">Gerar PDF</button>
      <button class="btn btn-blue" onclick="abrirSecao('')">Voltar</button>
    </section>

    <!-- Consulta -->
    <section id="consulta" class="section">
      <h2>Consulta de Registros</h2>
      <div id="listaRegistros"></div>
      <button class="btn btn-blue" onclick="abrirSecao('')">Voltar</button>
    </section>
  </main>

  <script>
    // üîπ Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBUF-WA58TIK259hYy7HECYLRbhOyqR1pE",
      authDomain: "atomotech-sistema.firebaseapp.com",
      projectId: "atomotech-sistema",
      storageBucket: "atomotech-sistema.appspot.com",
      messagingSenderId: "106133482163",
      appId: "1:106133482163:web:0fdcd843ae3e778fe15ec6"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    function abrirSecao(secao) {
      document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
      if (secao) document.getElementById(secao).style.display = 'block';
      if (secao === 'consulta') carregarRegistros();
    }

    function gerarNumero(prefixo) {
      const hoje = new Date();
      const data = String(hoje.getDate()).padStart(2,'0') + String(hoje.getMonth()+1).padStart(2,'0') + String(hoje.getFullYear()).slice(-2);
      const aleatorio = Math.floor(Math.random()*900+100);
      return `${prefixo}-${data}-${aleatorio}`;
    }

    function adicionarItem(tipo) {
      const tabela = tipo === "orcamento" ? document.querySelector("#tabelaOrcamento tbody") : document.querySelector("#tabelaEquipamentos tbody");
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input type="text"></td>
        <td><input type="number" value="1" min="1"></td>
        <td><input type="number" step="0.01" value="0"></td>
        <td><input type="text" disabled></td>
        <td><button onclick="this.parentElement.parentElement.remove()">Remover</button></td>
      `;
      tabela.appendChild(tr);
      atualizarTotais();
      tr.querySelectorAll("input").forEach(inp => inp.addEventListener("input", atualizarTotais));
    }

    function atualizarTotais() {
      document.querySelectorAll("table tbody tr").forEach(tr => {
        const qtd = tr.children[1].children[0].value;
        const valor = tr.children[2].children[0].value;
        tr.children[3].children[0].value = (qtd*valor).toFixed(2);
      });
    }

    async function salvarRegistro(tipo) {
      const numero = gerarNumero(tipo === "orcamento" ? "ORC" : "OS");
      let dados = { numero, data: new Date().toISOString() };

      if (tipo === "orcamento") {
        dados.cliente = document.getElementById("orcCliente").value;
        dados.descricao = document.getElementById("orcDescricao").value;
        dados.itens = [];
        document.querySelectorAll("#tabelaOrcamento tbody tr").forEach(tr=>{
          dados.itens.push({
            desc: tr.children[0].children[0].value,
            qtd: tr.children[1].children[0].value,
            unit: tr.children[2].children[0].value,
            total: tr.children[3].children[0].value
          });
        });
      } else {
        dados.cliente = document.getElementById("osCliente").value;
        dados.servico = document.getElementById("osServico").value;
        dados.tecnico = document.getElementById("osTecnico").value;
        dados.equipamentos = [];
        document.querySelectorAll("#tabelaEquipamentos tbody tr").forEach(tr=>{
          dados.equipamentos.push({
            desc: tr.children[0].children[0].value,
            qtd: tr.children[1].children[0].value,
            unit: tr.children[2].children[0].value,
            total: tr.children[3].children[0].value
          });
        });
      }

      await db.collection(tipo).add(dados);
      alert("‚úÖ Registro salvo no banco!");
      limparFormulario(tipo);
    }

    function limparFormulario(tipo) {
      if (tipo === "orcamento") {
        document.getElementById("orcCliente").value="";
        document.getElementById("orcDescricao").value="";
        document.querySelector("#tabelaOrcamento tbody").innerHTML="";
      } else {
        document.getElementById("osCliente").value="";
        document.getElementById("osServico").value="";
        document.getElementById("osTecnico").value="";
        document.querySelector("#tabelaEquipamentos tbody").innerHTML="";
      }
      alert("üßπ Formul√°rio limpo!");
    }

    // üîπ Consulta com atualiza√ß√£o em tempo real
    function carregarRegistros() {
      const lista = document.getElementById("listaRegistros");
      lista.innerHTML = "";

      ["orcamento","os"].forEach(tipo=>{
        db.collection(tipo).orderBy("data","desc").onSnapshot(snapshot=>{
          snapshot.docChanges().forEach(change=>{
            if (change.type === "added") {
              const d = change.doc.data();
              const div = document.createElement("div");
              div.className = "registro";
              div.id = change.doc.id;
              div.innerHTML = `
                <span><b>${tipo.toUpperCase()}</b> ‚Äî ${d.numero} ‚Äî ${d.cliente} ‚Äî ${new Date(d.data).toLocaleDateString()}</span>
                <span>
                  <button class="btn btn-blue" onclick="gerarPDF('${tipo}','${change.doc.id}')">PDF</button>
                  <button class="btn btn-red" onclick="excluirRegistro('${tipo}','${change.doc.id}')">Excluir</button>
                </span>
              `;
              lista.appendChild(div);
            }
            if (change.type === "removed") {
              document.getElementById(change.doc.id)?.remove();
            }
          });
        });
      });
    }

    async function excluirRegistro(tipo, id) {
      if (confirm("‚ùå Deseja excluir este registro?")) {
        await db.collection(tipo).doc(id).delete();
        alert("Registro exclu√≠do!");
      }
    }

    // üîπ PDF
    function gerarPDFFromForm(tipo) {
      gerarPDFBase(tipo);
      limparFormulario(tipo);
      alert("üìÑ PDF gerado com sucesso!");
    }

    async function gerarPDF(tipo, id) {
      const docRef = await db.collection(tipo).doc(id).get();
      const dados = docRef.data();
      gerarPDFBase(tipo, dados);
    }

    function gerarPDFBase(tipo, dados=null) {
      const docPDF = new jspdf.jsPDF();

      docPDF.setFontSize(16);
      docPDF.text(`AtomoTech - ${tipo === "orcamento" ? "Or√ßamento" : "Ordem de Servi√ßo"}`, 10, 20);

      const numero = dados ? dados.numero : gerarNumero(tipo === "orcamento" ? "ORC" : "OS");
      const cliente = dados ? dados.cliente : (tipo === "orcamento" ? document.getElementById("orcCliente").value : document.getElementById("osCliente").value);

      docPDF.setFontSize(12);
      docPDF.text(`N√∫mero: ${numero}`, 10, 40);
      docPDF.text(`Cliente: ${cliente}`, 10, 50);
      docPDF.text(`Data: ${new Date().toLocaleDateString()}`, 10, 60);

      if (tipo === "os") {
        const tecnico = dados ? dados.tecnico : document.getElementById("osTecnico").value;
        docPDF.text(`T√©cnico: ${tecnico}`, 10, 70);
      }

      let linhas = [];
      if (tipo === "orcamento") {
        const itens = dados ? dados.itens : [];
        (itens.length ? itens : Array.from(document.querySelectorAll("#tabelaOrcamento tbody tr"))).forEach(tr=>{
          if (dados) {
            linhas.push([tr.desc,tr.qtd,tr.unit,tr.total]);
          } else {
            linhas.push([
              tr.children[0].children[0].value,
              tr.children[1].children[0].value,
              tr.children[2].children[0].value,
              tr.children[3].children[0].value
            ]);
          }
        });
      } else {
        const eqs = dados ? dados.equipamentos : [];
        (eqs.length ? eqs : Array.from(document.querySelectorAll("#tabelaEquipamentos tbody tr"))).forEach(tr=>{
          if (dados) {
            linhas.push([tr.desc,tr.qtd,tr.unit,tr.total]);
          } else {
            linhas.push([
              tr.children[0].children[0].value,
              tr.children[1].children[0].value,
              tr.children[2].children[0].value,
              tr.children[3].children[0].value
            ]);
          }
        });
      }

      docPDF.autoTable({
        head: [["Descri√ß√£o", "Qtd", "Valor Unit.", "Total"]],
        body: linhas,
        startY: tipo === "orcamento" ? 80 : 90
      });

      const totalGeral = linhas.reduce((acc, l) => acc + parseFloat(l[3]||0), 0);
      docPDF.text(`Total Geral: R$ ${totalGeral.toFixed(2)}`, 150, docPDF.lastAutoTable.finalY + 10);

      docPDF.save(`${tipo}-${numero}.pdf`);
    }
  </script>
</body>
</html>
