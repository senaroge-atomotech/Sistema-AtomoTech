<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>AtomoTech â€” Sistema</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#f4f6f8; }
    header { background:#0b66ff; color:white; padding:16px; text-align:center; font-size:20px; font-weight:bold; }
    main { padding:20px; text-align:center; }

    .btn {
      display:inline-block; margin:8px; padding:12px 20px;
      border:none; border-radius:8px; cursor:pointer; font-size:15px; font-weight:bold;
      color:white; transition:0.3s;
    }
    .btn:hover { opacity:0.85; }

    /* Cores personalizadas */
    .btn-green { background:#28a745; }
    .btn-blue { background:#007bff; }
    .btn-gold { background:#d4a017; }
    .btn-grey { background:#6c757d; }
    .btn-red { background:#dc3545; }

    .section {
      display:none; text-align:left; margin-top:20px;
      background:white; padding:20px; border-radius:10px;
      box-shadow:0 0 8px rgba(0,0,0,0.1);
    }
    label { display:block; margin-top:10px; }
    input, textarea, select { width:100%; padding:8px; margin-top:4px; }
    table { width:100%; border-collapse:collapse; margin-top:15px; }
    table, th, td { border:1px solid #ccc; }
    th, td { padding:8px; text-align:left; }
  </style>
</head>
<body>
  <header>AtomoTech â€” Sistema de OrÃ§amentos & OS</header>
  <main>
    <button class="btn btn-green" onclick="abrirSecao('orcamento')">âž•Novo OrÃ§amento</button>
    <button class="btn btn-blue" onclick="abrirSecao('os')">ðŸ›  Nova Ordem de ServiÃ§o</button>
    <button class="btn btn-gold" onclick="abrirSecao('consulta')">ðŸ“‹ Gerenciar Documentos</button>

    <!-- OrÃ§amento -->
    <section id="orcamento" class="section">
      <h2>OrÃ§amento</h2>
      <label>Cliente: <input type="text" id="orcCliente"></label>
      <label>DescriÃ§Ã£o: <textarea id="orcDescricao"></textarea></label>
      <h3>Itens</h3>
      <table id="tabelaOrcamento">
        <thead>
          <tr><th>DescriÃ§Ã£o</th><th>Qtd</th><th>Valor Unit.</th><th>Total</th><th>AÃ§Ã£o</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <button class="btn btn-grey" onclick="adicionarItem('orcamento')">Adicionar Item</button>
      <br>
      <button class="btn btn-green" onclick="salvarRegistro('orcamento')">Salvar</button>
      <button class="btn btn-grey" onclick="limparFormulario('orcamento')">Limpar</button>
      <button class="btn btn-red" onclick="gerarPDFFromForm('orcamento')">Gerar PDF</button>
      <button class="btn btn-blue" onclick="abrirSecao('')">Voltar</button>
    </section>

    <!-- OS -->
    <section id="os" class="section">
      <h2>Ordem de ServiÃ§o</h2>
      <label>Cliente: <input type="text" id="osCliente"></label>
      <label>ServiÃ§o: <textarea id="osServico"></textarea></label>
      <label>TÃ©cnico ResponsÃ¡vel: <input type="text" id="osTecnico"></label>
      <h3>Equipamentos Usados</h3>
      <table id="tabelaEquipamentos">
        <thead>
          <tr><th>DescriÃ§Ã£o</th><th>Qtd</th><th>Valor Unit.</th><th>Total</th><th>AÃ§Ã£o</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <button class="btn btn-grey" onclick="adicionarItem('equipamento')">Adicionar Equipamento</button>
      <br>
      <button class="btn btn-green" onclick="salvarRegistro('os')">Salvar</button>
      <button class="btn btn-grey" onclick="limparFormulario('os')">Limpar</button>
      <button class="btn btn-red" onclick="gerarPDFFromForm('os')">Gerar PDF</button>
      <button class="btn btn-blue" onclick="abrirSecao('')">Voltar</button>
    </section>

    <!-- Consulta -->
    <section id="consulta" class="section">
      <h2>Consulta de Registros</h2>
      <div id="listaRegistros"></div>
      <button class="btn btn-blue" onclick="abrirSecao('')">Voltar</button>
    </section>
  </main>

  <script>
    // ðŸ”¹ Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBUF-WA58TIK259hYy7HECYLRbhOyqR1pE",
      authDomain: "atomotech-sistema.firebaseapp.com",
      projectId: "atomotech-sistema",
      storageBucket: "atomotech-sistema.firebasestorage.app",
      messagingSenderId: "106133482163",
      appId: "1:106133482163:web:0fdcd843ae3e778fe15ec6",
      measurementId: "G-34WWR2929E"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    function abrirSecao(secao) {
      document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
      if (secao) document.getElementById(secao).style.display = 'block';
      if (secao === 'consulta') carregarRegistros();
    }

    function gerarNumero(prefixo) {
      const hoje = new Date();
      const data = String(hoje.getDate()).padStart(2,'0') + String(hoje.getMonth()+1).padStart(2,'0') + String(hoje.getFullYear()).slice(-2);
      const aleatorio = Math.floor(Math.random()*900+100);
      return `${prefixo}-${data}-${aleatorio}`;
    }

    function adicionarItem(tipo) {
      const tabela = tipo === "orcamento" ? document.querySelector("#tabelaOrcamento tbody") : document.querySelector("#tabelaEquipamentos tbody");
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input type="text"></td>
        <td><input type="number" value="1" min="1"></td>
        <td><input type="number" step="0.01" value="0"></td>
        <td><input type="text" disabled></td>
        <td><button onclick="this.parentElement.parentElement.remove()">Remover</button></td>
      `;
      tabela.appendChild(tr);
      atualizarTotais();
      tr.querySelectorAll("input").forEach(inp => inp.addEventListener("input", atualizarTotais));
    }

    function atualizarTotais() {
      document.querySelectorAll("table tbody tr").forEach(tr => {
        const qtd = tr.children[1].children[0].value;
        const valor = tr.children[2].children[0].value;
        tr.children[3].children[0].value = (qtd*valor).toFixed(2);
      });
    }

    function salvarRegistro(tipo) {
      const numero = gerarNumero(tipo === "orcamento" ? "ORC" : "OS");
      let dados = { numero, data: new Date().toISOString() };

      if (tipo === "orcamento") {
        dados.cliente = document.getElementById("orcCliente").value;
        dados.descricao = document.getElementById("orcDescricao").value;
        dados.itens = [];
        document.querySelectorAll("#tabelaOrcamento tbody tr").forEach(tr=>{
          dados.itens.push({
            desc: tr.children[0].children[0].value,
            qtd: tr.children[1].children[0].value,
            unit: tr.children[2].children[0].value,
            total: tr.children[3].children[0].value
          });
        });
      } else {
        dados.cliente = document.getElementById("osCliente").value;
        dados.servico = document.getElementById("osServico").value;
        dados.tecnico = document.getElementById("osTecnico").value;
        dados.equipamentos = [];
        document.querySelectorAll("#tabelaEquipamentos tbody tr").forEach(tr=>{
          dados.equipamentos.push({
            desc: tr.children[0].children[0].value,
            qtd: tr.children[1].children[0].value,
            unit: tr.children[2].children[0].value,
            total: tr.children[3].children[0].value
          });
        });
      }

      db.collection(tipo).add(dados).then(()=>{
        alert("âœ… Registro salvo com sucesso!");
        limparFormulario(tipo);
      });
    }

    function limparFormulario(tipo) {
      if (tipo === "orcamento") {
        document.getElementById("orcCliente").value="";
        document.getElementById("orcDescricao").value="";
        document.querySelector("#tabelaOrcamento tbody").innerHTML="";
      } else {
        document.getElementById("osCliente").value="";
        document.getElementById("osServico").value="";
        document.getElementById("osTecnico").value="";
        document.querySelector("#tabelaEquipamentos tbody").innerHTML="";
      }
    }

    function carregarRegistros() {
      const lista = document.getElementById("listaRegistros");
      lista.innerHTML = "";
      ["orcamento","os"].forEach(tipo=>{
        db.collection(tipo).get().then(snapshot=>{
          snapshot.forEach(doc=>{
            const d = doc.data();
            const div = document.createElement("div");
            div.innerHTML = `<b>${tipo.toUpperCase()}:</b> ${d.numero} â€” ${d.cliente} â€” ${new Date(d.data).toLocaleDateString()} <button class="btn btn-red" onclick="gerarPDF('${tipo}','${doc.id}')">Gerar PDF</button>`;
            lista.appendChild(div);
          });
        });
      });
    }

    // ðŸ”¹ PDF (mesma versÃ£o para formulÃ¡rio e consulta)
    function gerarPDFFromForm(tipo) {
      gerarPDFBase(tipo);
      limparFormulario(tipo);
      alert("ðŸ“„ PDF gerado com sucesso!");
    }

    async function gerarPDF(tipo, id) {
      const docRef = await db.collection(tipo).doc(id).get();
      const dados = docRef.data();
      gerarPDFBase(tipo, dados);
    }

    function gerarPDFBase(tipo, dados=null) {
      const docPDF = new jspdf.jsPDF();
      docPDF.addImage("logo.png", "PNG", 10, 10, 30, 30);

      docPDF.setTextColor(200,200,200);
      docPDF.setFontSize(60);
      docPDF.text("ATOMOTECH", 105, 150, { align: "center", angle: 45 });

      docPDF.setTextColor(0,0,0);
      docPDF.setFontSize(16);
      docPDF.text(`AtomoTech - ${tipo === "orcamento" ? "OrÃ§amento" : "Ordem de ServiÃ§o"}`, 50, 20);

      const numero = dados ? dados.numero : gerarNumero(tipo === "orcamento" ? "ORC" : "OS");
      const cliente = dados ? dados.cliente : (tipo === "orcamento" ? document.getElementById("orcCliente").value : document.getElementById("osCliente").value);

      docPDF.setFontSize(12);
      docPDF.text(`NÃºmero: ${numero}`, 10, 50);
      docPDF.text(`Cliente: ${cliente}`, 10, 60);
      docPDF.text(`Data: ${new Date().toLocaleDateString()}`, 10, 70);

      if (tipo === "os") {
        const tecnico = dados ? dados.tecnico : document.getElementById("osTecnico").value;
        docPDF.text(`TÃ©cnico: ${tecnico}`, 10, 80);
      }

      let linhas = [];
      if (tipo === "orcamento") {
        const itens = dados ? dados.itens : [];
        (itens.length ? itens : Array.from(document.querySelectorAll("#tabelaOrcamento tbody tr"))).forEach(tr=>{
          if (dados) {
            linhas.push([tr.desc,tr.qtd,tr.unit,tr.total]);
          } else {
            linhas.push([
              tr.children[0].children[0].value,
              tr.children[1].children[0].value,
              tr.children[2].children[0].value,
              tr.children[3].children[0].value
            ]);
          }
        });
      } else {
        const eqs = dados ? dados.equipamentos : [];
        (eqs.length ? eqs : Array.from(document.querySelectorAll("#tabelaEquipamentos tbody tr"))).forEach(tr=>{
          if (dados) {
            linhas.push([tr.desc,tr.qtd,tr.unit,tr.total]);
          } else {
            linhas.push([
              tr.children[0].children[0].value,
              tr.children[1].children[0].value,
              tr.children[2].children[0].value,
              tr.children[3].children[0].value
            ]);
          }
        });
      }

      docPDF.autoTable({
        head: [["DescriÃ§Ã£o", "Qtd", "Valor Unit.", "Total"]],
        body: linhas,
        startY: tipo === "orcamento" ? 90 : 100
      });

      const totalGeral = linhas.reduce((acc, l) => acc + parseFloat(l[3]||0), 0);
      docPDF.text(`Total Geral: R$ ${totalGeral.toFixed(2)}`, 150, docPDF.lastAutoTable.finalY + 10);

      let assinaturaY = docPDF.lastAutoTable.finalY + 40;
      docPDF.line(20, assinaturaY, 90, assinaturaY);
      docPDF.text("Assinatura do Cliente", 20, assinaturaY + 10);

      if (tipo === "os") {
        docPDF.line(120, assinaturaY, 190, assinaturaY);
        docPDF.text("Assinatura do TÃ©cnico", 120, assinaturaY + 10);
      }

      const pageCount = docPDF.internal.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        docPDF.setPage(i);
        docPDF.setFontSize(10);
        docPDF.setTextColor(100);
        docPDF.text("AtomoTech â€¢ (11) 99999-9999 â€¢ contato@atomotech.com.br â€¢ www.atomotech.com.br", 105, 290, { align: "center" });
      }

      docPDF.save(`${tipo}-${numero}.pdf`);
    }
  </script>
</body>
</html>
