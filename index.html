<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AtomoTech - Gestão</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/js/all.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.14/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .header {
            background-color: #0d47a1;
        }
        .signature-pad {
            border: 1px solid #d1d5db;
            background-color: #f9fafb;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <header class="header text-white p-4 shadow-lg fixed top-0 left-0 right-0 z-50">
        <div class="container mx-auto flex items-center justify-between">
            <div class="flex items-center">
                <img src="logo.png" alt="AtomoTech Logo" class="h-8 mr-2">
                <h1 class="text-3xl font-bold">AtomoTech - Sistema de Gestão</h1>
            </div>
            <!-BOTAO DE TESTE BANCO DE DADOS->
          <!--  <div class="flex items-center space-x-4">
                <span id="user-status" class="text-sm font-medium">Conectando...</span>
                <a href="teste_BD.html" class="bg-gray-200 hover:bg-gray-300 text-gray-800 text-xs font-medium py-1 px-2 rounded-full transition-colors duration-200">
                    Testar Conexão
                </a>
            </div>  -->
        </div>
    </header>

    <main class="flex-1 mt-20 p-4 sm:p-6 lg:p-8">
        <div class="container mx-auto">
            <h2 class="text-2xl font-semibold mb-6 text-gray-800">Painel de Gestão</h2>
            
            <div id="main-menu" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-lg shadow-md flex flex-col items-center text-center">
                    <i class="fa-solid fa-file-invoice-dollar text-4xl text-green-600 mb-4"></i>
                    <h3 class="text-xl font-semibold mb-2">Novo Orçamento</h3>
                    <p class="text-gray-600 mb-4">Crie e envie orçamentos profissionais para seus clientes.</p>
                    <button onclick="mostrarPagina('orcamento')" class="px-6 py-2 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 transition-colors">
                        Criar Orçamento
                    </button>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md flex flex-col items-center text-center">
                    <i class="fa-solid fa-tools text-4xl text-blue-600 mb-4"></i>
                    <h3 class="text-xl font-semibold mb-2">Nova Ordem de Serviço</h3>
                    <p class="text-gray-600 mb-4">Gerencie serviços e colete assinaturas digitais.</p>
                    <button onclick="mostrarPagina('os')" class="px-6 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition-colors">
                        Criar Ordem de Serviço
                    </button>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md flex flex-col items-center text-center">
                    <i class="fa-solid fa-list-check text-4xl text-yellow-600 mb-4"></i>
                    <h3 class="text-xl font-semibold mb-2">Gerenciar Documentos</h3>
                    <p class="text-gray-600 mb-4">Visualize e edite todas as suas ordens de serviço e orçamentos.</p>
                    <button onclick="mostrarPagina('consultar')" class="px-6 py-2 bg-yellow-600 text-white rounded-lg shadow hover:bg-yellow-700 transition-colors">
                        Gerenciar
                    </button>
                </div>
            </div>

            <section id="orcamento" class="hidden">
                <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-lg p-8">
                    <div class="relative flex justify-between items-center mb-6">
                        <span id="voltar-btn-orc" onclick="voltarAoMenu()" class="absolute left-0 top-1/2 transform -translate-y-1/2 text-blue-500 hover:text-blue-700 transition-colors cursor-pointer">Voltar</span>
                        <div class="flex-grow text-center">
                            <h1 class="text-3xl font-bold text-gray-800 inline-block">Orçamento</h1>
                        </div>
                        <img src="logo.png" alt="Logo da AtomoTech" class="w-28 rounded-md ml-auto" onerror="this.onerror=null;this.src='https://placehold.co/150x50/e2e8f0/334155?text=AtomoTech';">
                    </div>

                    <input type="hidden" id="orcamentoId">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 text-sm">
                        <div>
                            <p class="font-bold text-gray-700">Orçamento:</p>
                            <p id="orcamento-numero" class="text-gray-900 font-mono"></p>
                        </div>
                        <div>
                            <p class="font-bold text-gray-700">Data:</p>
                            <p id="data-atual" class="text-gray-900"></p>
                        </div>
                        <div>
                            <div>
                                <p class="font-bold text-gray-700">Validade:</p>
                                <input id="validade-input" type="text" value="30 dias" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                        </div>
                        <div>
                            <p class="font-bold text-gray-700">Condições de Pagamento:</p>
                            <input id="condicoes-pagamento-input" type="text" value="Avista" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        <div>
                            <p class="font-bold text-gray-700">Status:</p>
                            <select id="status-select" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="Pendente">Pendente</option>
                                <option value="Aprovado">Aprovado</option>
                                <option value="Rejeitado">Rejeitado</option>
                                <option value="Cancelado">Cancelado</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-8 p-6 bg-gray-50 rounded-lg">
                        <h2 class="text-lg font-semibold text-gray-700 mb-4">Informações do Cliente</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <input id="cliente-nome" type="text" placeholder="Nome" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                            <input id="cliente-email" type="email" placeholder="Email" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                            <input id="cliente-telefone" type="tel" placeholder="Telefone" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                    </div>

                    <div class="overflow-x-auto mb-4">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Descrição</th>
                                    <th scope="col" class="px-6 py-3">Qtd</th>
                                    <th scope="col" class="px-6 py-3">Valor Unit.</th>
                                    <th scope="col" class="px-6 py-3">Total</th>
                                    <th scope="col" class="px-6 py-3"></th>
                                </tr>
                            </thead>
                            <tbody id="itens-tabela">
                                </tbody>
                            <tfoot>
                                <tr class="font-semibold text-gray-900">
                                    <td colspan="3" class="px-6 py-3 text-right">Total:</td>
                                    <td id="total-orcamento" class="px-6 py-3 text-right">R$ 0,00</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <button id="add-item-btn-orcamento" onclick="adicionarItem('itens-tabela')" class="mb-8 px-6 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors">Adicionar Item</button>
                    
                    <div class="flex justify-end gap-4 mb-8">
                        <button id="limpar-orcamento-btn" onclick="limparFormulario('orcamento')" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">Limpar</button>
                        <button id="salvar-orcamento-btn" onclick="salvarRegistro('orcamento')" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">Salvar</button>
                        <button id="gerar-pdf-orcamento-btn" onclick="gerarPDF('orcamento')" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">Gerar PDF</button>
                    </div>

                    <div class="border-t pt-6 text-sm text-center text-gray-600">
                        <p>Assinatura do Cliente</p>
                    </div>
                </div>
            </section>

            <section id="os" class="hidden">
                <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-lg p-8">
                    <div class="relative flex justify-between items-center mb-6">
                        <span id="voltar-btn-os" onclick="voltarAoMenu()" class="absolute left-0 top-1/2 transform -translate-y-1/2 text-blue-500 hover:text-blue-700 transition-colors cursor-pointer">Voltar</span>
                        <div class="flex-grow text-center">
                            <h1 class="text-3xl font-bold text-gray-800 inline-block">Ordem de Serviço</h1>
                        </div>
                        <img src="logo.png" alt="Logo da AtomoTech" class="w-28 rounded-md ml-auto" onerror="this.onerror=null;this.src='https://placehold.co/150x50/e2e8f0/334155?text=AtomoTech';">
                    </div>
                    <input type="hidden" id="osId">

                    <label class="block mt-4 font-bold">Cliente</label>
                    <input type="text" id="osCliente" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    
                    <label class="block mt-4 font-bold">Data de Início</label>
                    <input type="date" id="osDataInicio" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    
                    <label class="block mt-4 font-bold">Data de Término</label>
                    <input type="date" id="osDataTermino" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">

                    <label class="block mt-4 font-bold">Serviço</label>
                    <textarea id="osServico" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    
                    <label class="block mt-4 font-bold">Técnico Responsável</label>
                    <input type="text" id="osTecnico" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">

                    <h3 class="text-lg font-semibold mt-6 mb-2">Assinatura do Cliente</h3>
                    <div class="mb-4">
                        <canvas id="signatureCanvas" class="signature-pad w-full h-40"></canvas>
                        <button onclick="limparAssinatura()" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors">Limpar Assinatura</button>
                    </div>

                    <div class="flex justify-end gap-4 mb-8">
                      <button onclick="limparFormulario('os')" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">Limpar</button>
                      <button onclick="salvarRegistro('os')" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">Salvar</button>
                      <button onclick="gerarPDF('os')" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">Gerar PDF</button>
                    </div>
                </div>
            </section>

            <section id="consultar" class="hidden">
                <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-lg p-8">
                    <div class="relative flex justify-between items-center mb-6">
                        <span id="voltar-btn-consultar" onclick="voltarAoMenu()" class="absolute left-0 top-1/2 transform -translate-y-1/2 text-blue-500 hover:text-blue-700 transition-colors cursor-pointer">Voltar</span>
                        <div class="flex-grow text-center">
                            <h1 class="text-3xl font-bold text-gray-800 inline-block">Consulta de Registros</h1>
                        </div>
                        <img src="logo.png" alt="Logo da AtomoTech" class="w-28 rounded-md ml-auto" onerror="this.onerror=null;this.src='https://placehold.co/150x50/e2e8f0/334155?text=AtomoTech';">
                    </div>
                    <label class="block mt-4 font-bold">Tipo</label>
                    <select id="consultaTipo" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                      <option value="orcamento">Orçamento</option>
                      <option value="os">Ordem de Serviço</option>
                    </select>
                    <label class="block mt-4 font-bold">Cliente</label>
                    <input type="text" id="consultaCliente" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <div class="flex justify-end gap-4 mb-8">
                        <button onclick="consultarRegistros()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">Consultar</button>
                    </div>
                    <table id="tabelaConsulta" class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th>Número</th><th>Cliente</th><th>Data</th><th>Ações</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

        </div>
    </main>
    
    <script>
        // Firebase config do index (1).html
        const firebaseConfig = {
          apiKey: "AIzaSyBUF-WA58TIK259hYy7HECYLRbhOyqR1pE",
          authDomain: "atomotech-sistema.firebaseapp.com",
          projectId: "atomotech-sistema",
          storageBucket: "atomotech-sistema.firebasestorage.app",
          messagingSenderId: "106133482163",
          appId: "1:106133482163:web:0fdcd843ae3e778fe15ec6",
          measurementId: "G-34WWR2929E"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Variável global para o pad de assinatura
        let signaturePad;

        // Mostrar seções
        function mostrarPagina(id) {
            document.getElementById("main-menu").classList.add("hidden");
            document.querySelectorAll("section").forEach(sec => sec.classList.add("hidden"));
            document.getElementById(id).classList.remove("hidden");
            if(id === 'orcamento') {
                inicializarOrcamento();
            } else if (id === 'os') {
                inicializarAssinatura();
            }
        }

        // Inicializar a assinatura
        function inicializarAssinatura() {
            const canvas = document.getElementById('signatureCanvas');
            signaturePad = new SignaturePad(canvas, {
                backgroundColor: 'rgb(255, 255, 255)'
            });
            // Responsividade do canvas
            function resizeCanvas() {
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                canvas.getContext("2d").scale(ratio, ratio);
                signaturePad.clear();
            }
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();
        }

        function limparAssinatura() {
            if (signaturePad) {
                signaturePad.clear();
            }
        }

        // Voltar ao menu principal
        function voltarAoMenu() {
            document.querySelectorAll("section").forEach(sec => sec.classList.add("hidden"));
            document.getElementById("main-menu").classList.remove("hidden");
        }

        // Funções para o formulário de Orçamento
        function inicializarOrcamento() {
            const data = new Date();
            const dia = String(data.getDate()).padStart(2, '0');
            const mes = String(data.getMonth() + 1).padStart(2, '0');
            const ano = data.getFullYear().toString().substring(2);
            document.getElementById('data-atual').textContent = `${dia}/${mes}/${data.getFullYear()}`;
            
            const numeroAleatorio = Math.floor(100 + Math.random() * 900);
            document.getElementById('orcamento-numero').textContent = `${dia}${mes}${ano}-${numeroAleatorio}`;
            
            const clienteNomeInput = document.getElementById('cliente-nome');
            const clienteEmailInput = document.getElementById('cliente-email');
            const clienteTelefoneInput = document.getElementById('cliente-telefone');
            
            clienteNomeInput.addEventListener('input', () => {
                const nome = clienteNomeInput.value.trim();
                if (nome.length > 2) {
                    clienteEmailInput.value = `${nome.toLowerCase().replace(/ /g, '')}@exemplo.com`;
                    clienteTelefoneInput.value = `(99) 99999-9999`;
                }
            });
            
            adicionarItem('itens-tabela');
        }

        function adicionarItem(tabelaId, desc = '', qtd = 1, unit = 0) {
          const tbody = document.getElementById(tabelaId);
          const tr = document.createElement("tr");
          tr.classList.add('bg-white', 'border-b', 'hover:bg-gray-50');
          tr.innerHTML = `
            <td class="px-6 py-4"><input type="text" value="${desc}" class="descricao w-full px-2 py-1 border rounded-md focus:outline-none focus:ring-1 focus:ring-green-500"></td>
            <td class="px-6 py-4"><input type="number" value="${qtd}" class="qtd w-20 px-2 py-1 border rounded-md focus:outline-none focus:ring-1 focus:ring-green-500 text-right"></td>
            <td class="px-6 py-4"><input type="number" value="${unit}" class="valor-unit w-24 px-2 py-1 border rounded-md focus:outline-none focus:ring-1 focus:ring-green-500 text-right"></td>
            <td class="px-6 py-4 text-right item-total">R$ 0,00</td>
            <td class="px-6 py-4 text-right"><button onclick="this.closest('tr').remove(); atualizarTotal()" class="remover-item-btn text-red-600 hover:text-red-800 transition-colors">Remover</button></td>
          `;
          tbody.appendChild(tr);

          const qtdInput = tr.querySelector('.qtd');
          const unitInput = tr.querySelector('.valor-unit');
          const totalCell = tr.querySelector('.item-total');

          const updateTotals = () => {
              const qtd = parseFloat(qtdInput.value) || 0;
              const unit = parseFloat(unitInput.value) || 0;
              totalCell.textContent = (qtd * unit).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
              atualizarTotal();
          };

          qtdInput.addEventListener('input', updateTotals);
          unitInput.addEventListener('input', updateTotals);

          if (desc && qtd && unit) {
              updateTotals();
          } else {
              totalCell.textContent = 'R$ 0,00';
          }
          atualizarTotal();
        }

        function atualizarTotal() {
            let total = 0;
            document.querySelectorAll('#itens-tabela tr').forEach(row => {
                const subtotalText = row.querySelector('.item-total').textContent.replace('R$', '').replace(/\./g, '').replace(',', '.').trim();
                total += parseFloat(subtotalText);
            });
            document.getElementById('total-orcamento').textContent = total.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        // Salvar no Firestore (Orçamento e OS)
        async function salvarRegistro(tipo) {
            let dados = { data: new Date().toISOString() };
            let id = document.getElementById(tipo + "Id").value;
            const numero = id ? null : gerarNumero();
            
            if (tipo === "orcamento") {
                dados.numero = document.getElementById('orcamento-numero').textContent;
                dados.cliente = {
                    nome: document.getElementById("cliente-nome").value,
                    email: document.getElementById("cliente-email").value,
                    telefone: document.getElementById("cliente-telefone").value,
                };
                dados.orcamentoInfo = {
                    validade: document.getElementById('validade-input').value,
                    condicoesPagamento: document.getElementById('condicoes-pagamento-input').value,
                    status: document.getElementById('status-select').value,
                };
                dados.itens = [];
                document.querySelectorAll("#itens-tabela tr").forEach(tr => {
                    dados.itens.push({
                        desc: tr.querySelector('.descricao').value,
                        qtd: parseFloat(tr.querySelector('.qtd').value),
                        unit: parseFloat(tr.querySelector('.valor-unit').value),
                        total: tr.querySelector('.item-total').textContent
                    });
                });
                dados.total = document.getElementById('total-orcamento').textContent;
            } else {
                dados.cliente = document.getElementById("osCliente").value;
                dados.dataInicio = document.getElementById("osDataInicio").value;
                dados.dataTermino = document.getElementById("osDataTermino").value;
                dados.servico = document.getElementById("osServico").value;
                dados.tecnico = document.getElementById("osTecnico").value;
                dados.assinatura = signaturePad.isEmpty() ? null : signaturePad.toDataURL();
            }

            try {
                if (id) {
                    await db.collection(tipo).doc(id).update(dados);
                    alert("✏️ Registro atualizado!");
                } else {
                    const ref = await db.collection(tipo).add(dados);
                    document.getElementById(tipo + "Id").value = ref.id;
                    alert("✅ Registro salvo!");
                }
                limparFormulario(tipo);
            } catch (err) {
                console.error(err);
                alert("⚠️ Erro ao salvar!");
            }
        }

        // Gerar número DDMMYY-XXX
        function gerarNumero() {
          const hoje = new Date();
          const dia = String(hoje.getDate()).padStart(2, "0");
          const mes = String(hoje.getMonth() + 1).padStart(2, "0");
          const ano = String(hoje.getFullYear()).slice(-2);
          const seq = String(Math.floor(Math.random() * 1000)).padStart(3, "0");
          return `${dia}${mes}${ano}-${seq}`;
        }

        // Limpar formulário
        function limparFormulario(tipo) {
          document.getElementById(tipo + "Id").value = "";
          if (tipo === "orcamento") {
            document.getElementById("cliente-nome").value = "";
            document.getElementById("cliente-email").value = "";
            document.getElementById("cliente-telefone").value = "";
            document.getElementById('validade-input').value = '30 dias';
            document.getElementById('condicoes-pagamento-input').value = 'Avista';
            document.getElementById('status-select').value = 'Pendente';
            document.getElementById("itens-tabela").innerHTML = "";
            document.getElementById("total-orcamento").textContent = 'R$ 0,00';
            inicializarOrcamento();
          } else {
            document.getElementById("osCliente").value = "";
            document.getElementById("osDataInicio").value = "";
            document.getElementById("osDataTermino").value = "";
            document.getElementById("osServico").value = "";
            document.getElementById("osTecnico").value = "";
            limparAssinatura();
          }
          alert("✔️ Formulário limpo!");
        }

        // Gerar PDF com o novo design, status e marca d'água
        async function gerarPDF(tipo) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const addWatermark = (doc, imgData) => {
                const imgWidth = 150;
                const imgHeight = 150;
                const x = (doc.internal.pageSize.getWidth() - imgWidth) / 2;
                const y = (doc.internal.pageSize.getHeight() - imgHeight) / 2;
                doc.setGState(new doc.GState({ opacity: 0.1 }));
                doc.addImage(imgData, 'PNG', x, y, imgWidth, imgHeight);
                doc.setGState(new doc.GState({ opacity: 1.0 }));
            };
            
            const addHeader = (doc, title) => {
                const blueColor = [13, 71, 161];
                doc.setFillColor(...blueColor);
                doc.rect(0, 0, doc.internal.pageSize.getWidth(), 30, 'F');
                doc.setFontSize(24);
                doc.setTextColor(255, 255, 255);
                doc.text(title, doc.internal.pageSize.getWidth() / 2, 20, { align: "center" });
                doc.setFontSize(14);
                doc.text("AtomoTech", doc.internal.pageSize.getWidth() / 2, 30, { align: "center" });
                doc.setTextColor(0, 0, 0);
            };

            const img = new Image();
            img.src = "logo.png";
            
            img.onload = () => {
              if (tipo === 'orcamento') {
                  addHeader(doc, "Orçamento");
                  addWatermark(doc, img);
                  
                  const orcamentoNumeroSpan = document.getElementById('orcamento-numero');
                  const dataAtualSpan = document.getElementById('data-atual');
                  const validadeInput = document.getElementById('validade-input');
                  const condicoesPagamentoInput = document.getElementById('condicoes-pagamento-input');
                  const statusSelect = document.getElementById('status-select');
                  
                  const clienteNome = document.getElementById('cliente-nome').value;
                  const clienteEmail = document.getElementById('cliente-email').value;
                  const clienteTelefone = document.getElementById('cliente-telefone').value;

                  let y = 45;
                  const status = statusSelect.value;
                  let statusColor = [0, 0, 0];
                  const statusX = doc.internal.pageSize.getWidth() - 50;
                  const statusY = 10;
                  const statusWidth = 40;
                  const statusHeight = 10;
      
                  doc.setFontSize(10);
                  doc.setTextColor(255, 255, 255);
                  doc.setFont(undefined, 'bold');
                  
                  switch(status) {
                      case "Pendente":
                          statusColor = [255, 193, 7]; // Amarelo
                          doc.setFillColor(...statusColor);
                          doc.roundedRect(statusX, statusY, statusWidth, statusHeight, 2, 2, 'F');
                          doc.text(status.toUpperCase(), statusX + statusWidth / 2, statusY + statusHeight / 2 + 1, { align: 'center' });
                          break;
                      case "Aprovado":
                          statusColor = [40, 167, 69]; // Verde
                          doc.setFillColor(...statusColor);
                          doc.roundedRect(statusX, statusY, statusWidth, statusHeight, 2, 2, 'F');
                          doc.text(status.toUpperCase(), statusX + statusWidth / 2, statusY + statusHeight / 2 + 1, { align: 'center' });
                          break;
                      case "Rejeitado":
                          statusColor = [220, 53, 69]; // Vermelho
                          doc.setFillColor(...statusColor);
                          doc.roundedRect(statusX, statusY, statusWidth, statusHeight, 2, 2, 'F');
                          doc.text(status.toUpperCase(), statusX + statusWidth / 2, statusY + statusHeight / 2 + 1, { align: 'center' });
                          break;
                      case "Cancelado":
                          statusColor = [220, 53, 69]; // Vermelho
                          doc.setFillColor(...statusColor);
                          doc.roundedRect(statusX, statusY, statusWidth, statusHeight, 2, 2, 'F');
                          doc.text(status.toUpperCase(), statusX + statusWidth / 2, statusY + statusHeight / 2 + 1, { align: 'center' });
                          
                          doc.setDrawColor(255, 193, 7); // Amarelo para a cruz
                          doc.setLineWidth(1);
                          doc.line(statusX, statusY + statusHeight, statusX + statusWidth, statusY);
                          doc.line(statusX, statusY, statusX + statusWidth, statusY + statusHeight);
                          break;
                  }
                  
                  doc.setTextColor(0, 0, 0);
                  doc.setFont(undefined, 'normal');

                  doc.setFontSize(12);
                  doc.text(`Orçamento: ${orcamentoNumeroSpan.textContent}`, 20, y);
                  doc.text(`Data: ${dataAtualSpan.textContent}`, 105, y);
                  y += 7;
                  doc.text(`Validade: ${validadeInput.value}`, 20, y);
                  doc.text(`Condições de Pagamento: ${condicoesPagamentoInput.value}`, 105, y);
                  y += 7;
                  doc.text(`Status: ${statusSelect.value}`, 20, y);
                  y += 10;
                  
                  doc.setFontSize(14);
                  doc.text("Informações do Cliente", 20, y);
                  y += 7;
                  doc.setFontSize(12);
                  doc.text(`Nome: ${clienteNome}`, 20, y);
                  doc.text(`Email: ${clienteEmail}`, 105, y);
                  y += 7;
                  doc.text(`Telefone: ${clienteTelefone}`, 20, y);
                  y += 10;


                  const headers = ["Descrição", "Qtd", "Valor Unit.", "Total"];
                  const dataRows = [];
                  document.querySelectorAll('#itens-tabela tr').forEach(row => {
                      const rowData = [
                          row.querySelector('.descricao').value,
                          row.querySelector('.qtd').value,
                          row.querySelector('.valor-unit').value,
                          row.querySelector('.item-total').textContent
                      ];
                      dataRows.push(rowData);
                  });
                  
                  doc.autoTable({
                      head: [headers],
                      body: dataRows,
                      startY: y,
                      theme: 'grid',
                      styles: { 
                          cellPadding: 2, 
                          fontSize: 10,
                          tableLineColor: [220, 220, 220],
                          tableLineWidth: 0.1
                      },
                      headStyles: { fillColor: [59, 130, 246], textColor: 255 },
                      columnStyles: {
                          0: { cellWidth: 100 },
                          1: { cellWidth: 20 },
                          2: { cellWidth: 30 },
                          3: { cellWidth: 40 }
                      }
                  });

                  y = doc.autoTable.previous.finalY + 5;
                  doc.setFontSize(12);
                  doc.text(`Total: ${document.getElementById('total-orcamento').textContent}`, doc.internal.pageSize.getWidth() - 20, y, { align: "right" });
                  y += 20;

                  doc.setDrawColor(220, 220, 220);
                  doc.line(60, y, 150, y);
                  y += 5;
                  doc.text("Assinatura do Cliente", doc.internal.pageSize.getWidth() / 2, y, { align: "center" });

                  const orcamentoNumeroPDF = orcamentoNumeroSpan.textContent.replace(/ /g, '_').replace('#', '');
                  doc.save(`orcamento-${orcamentoNumeroPDF}.pdf`);

              } else {
                  // PDF para OS
                  addHeader(doc, "Ordem de Serviço");
                  addWatermark(doc, img);
                  
                  const cliente = document.getElementById('osCliente').value;
                  const servico = document.getElementById('osServico').value;
                  const tecnico = document.getElementById('osTecnico').value;
                  const dataInicio = document.getElementById('osDataInicio').value;
                  const dataTermino = document.getElementById('osDataTermino').value;

                  const numero = gerarNumero();
                  let y = 45;
                  
                  doc.setFontSize(12);
                  doc.text(`Número da OS: ${numero}`, 20, y);
                  y += 7;
                  doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 20, y);
                  y += 10;
                  
                  doc.setFontSize(14);
                  doc.text("Informações da Ordem de Serviço", 20, y);
                  y += 7;
                  doc.setFontSize(12);
                  doc.text(`Cliente: ${cliente}`, 20, y);
                  y += 7;
                  doc.text(`Técnico Responsável: ${tecnico}`, 20, y);
                  y += 7;
                  if (dataInicio) {
                      doc.text(`Data de Início: ${dataInicio.split('-').reverse().join('/')}`, 20, y);
                      y += 7;
                  }
                  if (dataTermino) {
                      doc.text(`Data de Término: ${dataTermino.split('-').reverse().join('/')}`, 20, y);
                      y += 7;
                  }
                  
                  y += 3;
                  doc.setFontSize(14);
                  doc.text("Serviço Executado", 20, y);
                  y += 7;
                  doc.setFontSize(12);
                  const splitServico = doc.splitTextToSize(servico, 170);
                  doc.text(splitServico, 20, y);
                  y += (splitServico.length * 5) + 10;
                  
                  // Assinatura sempre no rodapé
                  const signatureData = signaturePad.toDataURL();
                  if (signatureData) {
                      const sigY = doc.internal.pageSize.getHeight() - 40;
                      doc.addImage(signatureData, 'PNG', 20, sigY - 20, 100, 20);
                      doc.setDrawColor(220, 220, 220);
                      doc.line(20, sigY, 120, sigY);
                      doc.text("Assinatura do Cliente", doc.internal.pageSize.getWidth() / 2, sigY + 5, { align: "center" });
                  } else {
                      const sigY = doc.internal.pageSize.getHeight() - 25;
                      doc.setDrawColor(220, 220, 220);
                      doc.line(60, sigY, 150, sigY);
                      doc.text("Assinatura do Cliente", doc.internal.pageSize.getWidth() / 2, sigY + 5, { align: "center" });
                  }

                  doc.save(`os-${numero}.pdf`);
              }
            };

            img.onerror = () => {
                alert("Erro ao carregar a imagem 'logo.png'. Verifique se o arquivo existe e o caminho está correto.");
            };
        }

        // Consultar registros
        async function consultarRegistros() {
          const tipo = document.getElementById("consultaTipo").value;
          const cliente = document.getElementById("consultaCliente").value;
          let query = db.collection(tipo);
          if (cliente) query = query.where("cliente", "==", cliente);
          const snap = await query.get();
          const tbody = document.querySelector("#tabelaConsulta tbody");
          tbody.innerHTML = "";
          snap.forEach(docSnap => {
            const d = docSnap.data();
            const tr = document.createElement("tr");
            tr.innerHTML = `<td>${d.numero || ""}</td><td>${d.cliente.nome || d.cliente || ""}</td><td>${d.data.split("T")[0]}</td>
              <td><button onclick="editarRegistro('${tipo}','${docSnap.id}')" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-colors mr-2">Editar</button>
              <button onclick="excluirRegistro('${tipo}','${docSnap.id}')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">Excluir</button></td>`;
            tbody.appendChild(tr);
          });
        }
        
        // Excluir registro com confirmação
        async function excluirRegistro(tipo, id) {
            const confirmacao = confirm("Tem certeza que deseja excluir este registro? Esta ação é irreversível.");
            if (confirmacao) {
                try {
                    await db.collection(tipo).doc(id).delete();
                    alert("🗑️ Registro excluído com sucesso!");
                    consultarRegistros();
                } catch (err) {
                    console.error("Erro ao excluir registro: ", err);
                    alert("⚠️ Erro ao excluir registro. Tente novamente.");
                }
            }
        }

        // Editar registro
        async function editarRegistro(tipo, id) {
          const docSnap = await db.collection(tipo).doc(id).get();
          if (!docSnap.exists) return;
          const d = docSnap.data();
          document.getElementById(tipo + "Id").value = id;

          if (tipo === "orcamento") {
            mostrarPagina("orcamento");
            document.getElementById("orcamento-numero").textContent = d.numero || "";
            document.getElementById("data-atual").textContent = d.data ? d.data.split("T")[0] : "";
            document.getElementById("cliente-nome").value = d.cliente.nome || "";
            document.getElementById("cliente-email").value = d.cliente.email || "";
            document.getElementById("cliente-telefone").value = d.cliente.telefone || "";
            document.getElementById('validade-input').value = d.orcamentoInfo.validade || '30 dias';
            document.getElementById('condicoes-pagamento-input').value = d.orcamentoInfo.condicoesPagamento || 'Avista';
            document.getElementById('status-select').value = d.orcamentoInfo.status || 'Pendente';
            
            const tbody = document.getElementById("itens-tabela");
            tbody.innerHTML = "";
            (d.itens || []).forEach(item => {
                adicionarItem('itens-tabela', item.desc, item.qtd, item.unit);
            });
            atualizarTotal();
          } else {
            mostrarPagina("os");
            document.getElementById("osCliente").value = d.cliente || "";
            document.getElementById("osServico").value = d.servico || "";
            document.getElementById("osTecnico").value = d.tecnico || "";
            document.getElementById("osDataInicio").value = d.dataInicio || "";
            document.getElementById("osDataTermino").value = d.dataTermino || "";
            limparAssinatura(); // Sempre limpa a assinatura para que uma nova possa ser feita
          }
        }
    </script>
</body>
</html>


