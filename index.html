<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>AtomoTech ‚Äî Sistema</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {font-family: Arial, sans-serif; margin:0; background:#f4f6f9;}
    header {background:#0b66ff; color:white; padding:16px; font-size:22px; font-weight:bold;}
    .container {padding:20px;}
    .cards {display:flex; gap:20px; justify-content:center; margin-top:30px;}
    .card {
      background:white; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.15);
      padding:20px; width:280px; text-align:center;
    }
    .card button {
      padding:10px 20px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; color:white;
    }
    .orc {background:#28a745;} .orc:hover {background:#218838;}
    .os {background:#007bff;} .os:hover {background:#0069d9;}
    .docs {background:#d39e00;} .docs:hover {background:#b58100;}
    section {display:none; padding:20px;}
    h2 {color:#333;}
    table {width:100%; border-collapse:collapse; margin-top:10px;}
    table, th, td {border:1px solid #ccc;}
    th, td {padding:8px; text-align:left;}
    input[type="text"], input[type="number"] {width:95%; padding:5px;}
    .btn {padding:8px 16px; margin:5px; border:none; border-radius:5px; cursor:pointer; color:white; font-weight:bold;}
    .btn-save {background:#28a745;} .btn-save:hover {background:#218838;}
    .btn-clear {background:#6c757d;} .btn-clear:hover {background:#5a6268;}
    .btn-pdf {background:#17a2b8;} .btn-pdf:hover {background:#117a8b;}
  </style>
</head>
<body>
  <header>AtomoTech ‚Äî Sistema</header>
  <div class="container">
    <div class="cards">
      <div class="card">
        <h3>üìÑ Novo Or√ßamento</h3>
        <p>Crie e envie or√ßamentos profissionais para seus clientes.</p>
        <button class="orc" onclick="abrirPagina('orcamento')">Criar Or√ßamento</button>
      </div>
      <div class="card">
        <h3>üõ†Ô∏è Nova Ordem de Servi√ßo</h3>
        <p>Gerencie servi√ßos e equipamentos usados.</p>
        <button class="os" onclick="abrirPagina('os')">Criar Ordem de Servi√ßo</button>
      </div>
      <div class="card">
        <h3>üìÇ Gerenciar Documentos</h3>
        <p>Visualize or√ßamentos e ordens de servi√ßo.</p>
        <button class="docs" onclick="abrirPagina('consultar')">Gerenciar</button>
      </div>
    </div>
  </div>

  <!-- P√°gina Or√ßamento -->
  <section id="orcamento">
    <h2>Novo Or√ßamento</h2>
    <input type="hidden" id="orcamentoId">
    <label>Cliente: <input type="text" id="orcCliente"></label><br><br>
    <label>Descri√ß√£o: <input type="text" id="orcDescricao"></label>
    <table id="tabelaOrcamento">
      <thead><tr><th>Item</th><th>Qtd</th><th>Valor Unit.</th><th>Total</th><th>A√ß√£o</th></tr></thead>
      <tbody></tbody>
    </table>
    <button onclick="addLinha('tabelaOrcamento')">Adicionar Item</button><br><br>
    <button class="btn btn-save" onclick="salvarRegistro('orcamento')">Salvar</button>
    <button class="btn btn-clear" onclick="limparFormulario('orcamento')">Limpar</button>
    <button class="btn btn-pdf" onclick="gerarPDF('orcamento')">Gerar PDF</button>
  </section>

  <!-- P√°gina Ordem de Servi√ßo -->
  <section id="os">
    <h2>Nova Ordem de Servi√ßo</h2>
    <input type="hidden" id="osId">
    <label>Cliente: <input type="text" id="osCliente"></label><br><br>
    <label>Servi√ßo: <input type="text" id="osServico"></label><br><br>
    <label>T√©cnico: <input type="text" id="osTecnico"></label>
    <table id="tabelaEquipamentos">
      <thead><tr><th>Equipamento</th><th>Qtd</th><th>Valor Unit.</th><th>Total</th><th>A√ß√£o</th></tr></thead>
      <tbody></tbody>
    </table>
    <button onclick="addLinha('tabelaEquipamentos')">Adicionar Equipamento</button><br><br>
    <button class="btn btn-save" onclick="salvarRegistro('os')">Salvar</button>
    <button class="btn btn-clear" onclick="limparFormulario('os')">Limpar</button>
    <button class="btn btn-pdf" onclick="gerarPDF('os')">Gerar PDF</button>
  </section>

  <!-- P√°gina Consultar -->
  <section id="consultar">
    <h2>üìÇ Consultar Documentos</h2>
    <div id="listaDocs"></div>
  </section>

<script>
  // Config Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyBUF-WA58TIK259hYy7HECYLRbhOyqR1pE",
    authDomain: "atomotech-sistema.firebaseapp.com",
    projectId: "atomotech-sistema",
    storageBucket: "atomotech-sistema.firebasestorage.app",
    messagingSenderId: "106133482163",
    appId: "1:106133482163:web:0fdcd843ae3e778fe15ec6",
    measurementId: "G-34WWR2929E"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Navega√ß√£o
  function abrirPagina(id) {
    document.querySelectorAll("section").forEach(s => s.style.display="none");
    document.getElementById(id).style.display="block";
    if(id==="consultar") carregarDocumentos();
  }

  // Adicionar linha na tabela
  function addLinha(tabela) {
    let tbody = document.querySelector("#"+tabela+" tbody");
    let tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input type="text"></td>
      <td><input type="number" min="1" value="1" onchange="calcLinha(this)"></td>
      <td><input type="number" min="0" step="0.01" value="0" onchange="calcLinha(this)"></td>
      <td><input type="text" readonly></td>
      <td><button onclick="this.parentElement.parentElement.remove()">üóëÔ∏è</button></td>`;
    tbody.appendChild(tr);
  }

  // Calcular linha
  function calcLinha(el) {
    let tr = el.parentElement.parentElement;
    let qtd = tr.children[1].children[0].value;
    let unit = tr.children[2].children[0].value;
    tr.children[3].children[0].value = (qtd*unit).toFixed(2);
  }

  // Gerar n√∫mero sequencial
  function gerarNumero(prefixo){return prefixo+"-"+Date.now();}

  // Salvar no Firestore
  async function salvarRegistro(tipo) {
    let id = document.getElementById(tipo+"Id").value;
    const numero = id ? null : gerarNumero(tipo==="orcamento"?"ORC":"OS");
    let dados = { data:new Date().toISOString() };

    if(tipo==="orcamento"){
      dados.cliente=document.getElementById("orcCliente").value;
      dados.descricao=document.getElementById("orcDescricao").value;
      dados.itens=[];
      document.querySelectorAll("#tabelaOrcamento tbody tr").forEach(tr=>{
        dados.itens.push({
          desc:tr.children[0].children[0].value,
          qtd:tr.children[1].children[0].value,
          unit:tr.children[2].children[0].value,
          total:tr.children[3].children[0].value
        });
      });
    }else{
      dados.cliente=document.getElementById("osCliente").value;
      dados.servico=document.getElementById("osServico").value;
      dados.tecnico=document.getElementById("osTecnico").value;
      dados.equipamentos=[];
      document.querySelectorAll("#tabelaEquipamentos tbody tr").forEach(tr=>{
        dados.equipamentos.push({
          desc:tr.children[0].children[0].value,
          qtd:tr.children[1].children[0].value,
          unit:tr.children[2].children[0].value,
          total:tr.children[3].children[0].value
        });
      });
    }

    try{
      if(id){
        await db.collection(tipo).doc(id).update(dados);
        alert("‚úèÔ∏è Registro atualizado!");
      }else{
        dados.numero=numero;
        const ref=await db.collection(tipo).add(dados);
        document.getElementById(tipo+"Id").value=ref.id;
        alert("‚úÖ Registro criado!");
      }
      limparFormulario(tipo);
    }catch(err){console.error(err);alert("‚ö†Ô∏è Erro ao salvar.");}
  }

  // Limpar formul√°rio
  function limparFormulario(tipo){
    document.getElementById(tipo+"Id").value="";
    if(tipo==="orcamento"){
      document.getElementById("orcCliente").value="";
      document.getElementById("orcDescricao").value="";
      document.querySelector("#tabelaOrcamento tbody").innerHTML="";
    }else{
      document.getElementById("osCliente").value="";
      document.getElementById("osServico").value="";
      document.getElementById("osTecnico").value="";
      document.querySelector("#tabelaEquipamentos tbody").innerHTML="";
    }
  }

  // Gerar PDF com logo em marca d'√°gua
  async function gerarPDF(tipo){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const img = new Image();
    img.src = "logo.png";
    img.onload = function(){
      // Marca d'√°gua
      doc.setGState(new doc.GState({opacity:0.1}));
      doc.addImage(img,"PNG",40,60,130,130);
      doc.setGState(new doc.GState({opacity:1}));

      doc.setFontSize(16);
      doc.text(tipo==="orcamento"?"Or√ßamento":"Ordem de Servi√ßo",20,20);

      let y=40;
      if(tipo==="orcamento"){
        doc.text("Cliente: "+document.getElementById("orcCliente").value,20,y);
        y+=10;
        doc.text("Descri√ß√£o: "+document.getElementById("orcDescricao").value,20,y);
      }else{
        doc.text("Cliente: "+document.getElementById("osCliente").value,20,y);
        y+=10;
        doc.text("Servi√ßo: "+document.getElementById("osServico").value,20,y);
        y+=10;
        doc.text("T√©cnico: "+document.getElementById("osTecnico").value,20,y);
      }
      doc.save(tipo+".pdf");
    };
  }

  // Carregar documentos
  async function carregarDocumentos(){
    let div=document.getElementById("listaDocs");
    div.innerHTML="";
    for(const tipo of ["orcamento","os"]){
      const snap=await db.collection(tipo).get();
      snap.forEach(docu=>{
        let d=docu.data();
        let el=document.createElement("div");
        el.innerHTML=`<b>${tipo.toUpperCase()}:</b> ${d.cliente||""} - ${d.numero||""}`;
        div.appendChild(el);
      });
    }
  }
</script>
</body>
</html>
